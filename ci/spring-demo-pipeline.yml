resources:
- name: release
  type: s3
  source:
    bucket: releases
    access_key_id: ((minio.user))
    secret_access_key: ((minio.password))
    endpoint: http://minio.ellin.net
    regexp: release-(.*).tgz
- name: gh-release
  type: github-release
  source:
    user: jeffellin
    repository: spring-demo
    access_token: ((git.access-token))    
- name: source-code
  type: git
  source:
    uri: git@github.com:jeffellin/spring-demo.git
    branch: deployment-two
    private_key: ((private_key))
- name: config
  type: git
  source:
    uri: git@github.com:jeffellin/spring-demo-helm.git
    branch: dev
    private_key: ((private_key))
- name: config-updated
  type: git
  source:
    uri: git@github.com:jeffellin/spring-demo-helm.git
    branch: dev
    private_key: ((private_key))
- name: docker-image
  type: docker-image
  source:
    repository: harbor.ellin.net:443/library/spring-demo
    username: jeff
    password: ((harbor.password))
    insecure_registries:
      - harbor.ellin.net:443
jobs:
  - name: build-project
    serial: true
    plan:
      - get: source-code
        trigger: true
      # - get: version
      #   params: {bump: minor}
      - task: build-project
        file: source-code/ci/tasks/maven-build-task.yml
      - put: release
        params:
          file: packed-release/release-*.tgz
      # - put: version
      #   params: {file: version/version}
  - name: deploy-image
    plan:
      - get: release
        passed: [build-project]
        trigger: true
      - task: push-to-docker
        config:
          inputs:
          - name: release
          outputs:
          - name: docker-build
          platform: linux
          image_resource:
            type: docker-image
            source: {repository: busybox}
          run:
            path: sh
            args: 
              - -exc
              - |
                ls
                ls release
                VERSION=$(cat release/version)
                tar xvf release/release-${VERSION}.tgz -C docker-build
                mv docker-build/web-demo-${VERSION}.jar docker-build/web-demo.jar
      - put: docker-image
        params:
          build: docker-build
          tag_file: release/version
          tag_as_latest: true
          labels:
            version: snapshot
  - name: update-dev-config
    plan:
      - get: release
        passed: [deploy-image]
        trigger: true
      - get: config
      - get: source-code
      - task: push-versions-git
        config:
          inputs:
          - name: config
          - name: release
          - name: source-code
          outputs:
          - name: config-updated
          platform: linux
          image_resource:
            type: docker-image
            source: {repository: alpine/git}
          run:
            path: /bin/sh
            args:
            - source-code/ci/tasks/update-versions.sh
      - put: config-updated
        params: {repository: config-updated}
  #     - task: update-deployment
  #       file: source-code/ci/tasks/pks-deploy-task.yml
  #       params:
  #         HELM_USER: ((HELM_USER))
  #         HELM_PASSWORD: ((HELM_PASSWORD))
  #         HELM_CA_PATH: ((HELM_CA_PATH))
  #         HELM_URL: ((HELM_URL))
  #         PKS_ENDPOINT: ((PKS_ENDPOINT))
  #         PKS_USER: ((PKS_USER))
  #         PKS_PASSWORD: ((PKS_PASSWORD))
  #         PKS_CLUSTER: ((PKS_CLUSTER))
  - name: tag-release
    plan:
      - get: gh-release
        trigger: true
      - task: view-contents
        params:
          AWS_ACCESS_KEY_ID: ((minio.user))
          AWS_SECRET_ACCESS_KEY: ((minio.password))
          S3_ENDPOINT: http://minio.ellin.net
          S3_BUCKET: releases
          S3_SIGNATURE: s3v4
        config:
          inputs:
          - name: gh-release
          outputs:
          - name: docker-build
          platform: linux
          image_resource:
            type: docker-image
            source: {repository: boycey/alpine-aws-cli}
          params:
             AWS_ACCESS_KEY_ID:
             AWS_SECRET_ACCESS_KEY:
             S3_ENDPOINT:
             S3_BUCKET:
             S3_SIGNATURE: 
          run:
            path: sh
            args: 
              - -exc
              - |
                SHA=$(cat gh-release/commit_sha)
                SHA=${SHA:0:6}
                aws configure set default.s3.signature_version ${S3_SIGNATURE}
                aws --endpoint-url ${S3_ENDPOINT} s3 ls
                aws --endpoint-url ${S3_ENDPOINT} s3 cp s3://${S3_BUCKET}/release-${SHA}.tgz .
                tar xvf release-${SHA}.tgz -C docker-build
                mv docker-build/web-demo-${SHA}.jar docker-build/web-demo.jar   
      - put: docker-image
        params:
          build: docker-build
          tag_file: gh-release/tag     
