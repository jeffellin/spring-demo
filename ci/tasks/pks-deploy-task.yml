---
platform: linux

image_resource:
  type: docker-image
  source:
    repository: pivotalservices/pks-kubectl
    tag: latest

inputs:
  - name: release
  - name: docker-image

  
params:
  PKS_USER: ((PKS_USER))
  PKS_PASSWORD: ((PKS_PASSWORD))
  PKS_ENDPOINT: ((PKS_ENDPOINT))
  PKS_CLUSTER: ((PKS_CLUSTER))

run:
  path: sh
  args: 
    - -exc
    - |
      VERSION=$(cat release/version)
      ls
      ls release
      cd release
      tar xvf release-${VERSION}.tgz
      pks login -a ${PKS_ENDPOINT} -u ${PKS_USER} -p ${PKS_PASSWORD} -k
      pks get-credentials ${PKS_CLUSTER}
      kubectl get pods
      template=`cat "spring-demo-pod.yml" | sed "s/{{VERSION}}/$VERSION/g"`
      # apply the yml with the substituted value
      echo "$template" | kubectl apply -f -